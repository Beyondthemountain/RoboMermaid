name: Carve diagrams (check)

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  carve-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # If your carving script depends on mermaid-cli, install it.
      # If you have package-lock.json, prefer `npm ci`.
      - name: Install Node dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      # If you have Python deps, use requirements.txt (optional).
      - name: Install Python dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run carving script
        run: |
          python scripts/carve_diagrams.py

      - name: Fail if outputs changed
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "Carved outputs are not up-to-date. Run scripts/carve_diagrams.py and commit the changes."
            git diff --name-only
            exit 1
          fi
